(()=>{var b=Object.defineProperty;var p=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable;var f=(l,e,a)=>e in l?b(l,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):l[e]=a,n=(l,e)=>{for(var a in e||(e={}))y.call(e,a)&&f(l,a,e[a]);if(p)for(var a of p(e))h.call(e,a)&&f(l,a,e[a]);return l};var _=class{constructor({wrapper:e,page:a,frm:i,bom_configurator:t}){this.$wrapper=$(e),this.page=a,this.bom_configurator=t,this.frm=i,this.make(),this.prepare_layout(),this.bind_events()}add_boms(){this.frm.call({method:"add_boms",freeze:!0,doc:this.frm.doc})}make(){let e=n(n({},this.tree_options()),this.tree_methods());frappe.views.trees["BOM Configurator"]=new frappe.views.TreeView(e);let a=frappe.views.trees["BOM Configurator"].tree.root_node;frappe.views.trees["BOM Configurator"].tree.show_toolbar(a),frappe.views.trees["BOM Configurator"].tree.load_children(a,!0),this.tree_view=frappe.views.trees["BOM Configurator"]}bind_events(){frappe.views.trees["BOM Configurator"].events={frm:this.frm,add_item:this.add_item,add_sub_assembly:this.add_sub_assembly,set_query_for_workstation:this.set_query_for_workstation,get_sub_assembly_modal_fields:this.get_sub_assembly_modal_fields,convert_to_sub_assembly:this.convert_to_sub_assembly,delete_node:this.delete_node,edit_bom:this.edit_bom,load_tree:this.load_tree,set_default_qty:this.set_default_qty}}tree_options(){return{parent:this.$wrapper.get(0),body:this.$wrapper.get(0),doctype:"BOM Configurator",page:this.page,expandable:!0,title:__("Configure Product Assembly"),breadcrumb:"Manufacturing",get_tree_nodes:"erpnext.manufacturing.doctype.bom_creator.bom_creator.get_children",root_label:this.frm.doc.item_code,disable_add_node:!0,get_tree_root:!1,show_expand_all:!1,extend_toolbar:!1,do_not_make_page:!0,do_not_setup_menu:!0}}tree_methods(){var i;let e=this,a=frappe.views.trees["BOM Configurator"];return{onload:function(t){t.args.parent_id=e.frm.doc.name,t.args.parent=e.frm.doc.item_code,t.parent=e.$wrapper.get(0),t.body=e.$wrapper.get(0),t.make_tree()},onrender(t){let r=t.data.qty||e.frm.doc.qty,o=t.data.uom||e.frm.doc.uom,d=t.data.name||e.frm.doc.name,s=t.data.amount;t.data.value===e.frm.doc.item_code&&(s=e.frm.doc.raw_material_cost),s=frappe.format(s,{fieldtype:"Currency",currency:e.frm.doc.currency}),$(`
					<div class="pill small pull-right bom-qty-pill"
						style="background-color: var(--bg-white);
							color: var(--text-on-gray);
							font-weight:450;
							margin-right: 40px;
							display: inline-flex;
							min-width: 128px;
							border: 1px solid var(--bg-gray);
						">
							<div style="padding-right:5px" data-bom-qty-docname="${d}">${r} ${o}</div>
							<div class="fg-item-amt" style="padding-left:12px; border-left:1px solid var(--bg-gray)">
								${s}
							</div>
					</div>

				`).insertBefore(t.$ul)},toolbar:((i=this.frm)==null?void 0:i.doc.docstatus)===0?[{label:__(frappe.utils.icon("edit","sm")+" BOM"),click:function(t){let r=frappe.views.trees["BOM Configurator"];r.events.edit_bom(t,r)},btnClass:"hidden-xs"},{label:__(frappe.utils.icon("add","sm")+" Raw Material"),click:function(t){let r=frappe.views.trees["BOM Configurator"];r.events.add_item(t,r)},condition:function(t){return t.expandable},btnClass:"hidden-xs"},{label:__(frappe.utils.icon("add","sm")+" Sub Assembly"),click:function(t){let r=frappe.views.trees["BOM Configurator"];r.events.add_sub_assembly(t,r)},condition:function(t){return t.expandable},btnClass:"hidden-xs"},{label:__("Collapse All"),click:function(t){let r=frappe.views.trees["BOM Configurator"];t.expanded?(t.$tree_link.trigger("click"),t.$toolbar.find(".expand-all-btn").html(__("Expand All"))):(r.tree.load_children(t,!0),$(t.parent[0]).find(".tree-children").show(),t.$toolbar.find(".expand-all-btn").html(__("Collapse All")))},condition:function(t){return t.expandable&&t.is_root},btnClass:"hidden-xs expand-all-btn"},{label:__(frappe.utils.icon("move","sm")+" Sub Assembly"),click:function(t){let r=frappe.views.trees["BOM Configurator"];r.events.convert_to_sub_assembly(t,r)},condition:function(t){return!t.expandable},btnClass:"hidden-xs"},{label:__(frappe.utils.icon("delete","sm")+" Item"),click:function(t){let r=frappe.views.trees["BOM Configurator"];r.events.delete_node(t,r)},condition:function(t){return!t.is_root},btnClass:"hidden-xs"}]:[{label:__("Expand All"),click:function(t){let r=frappe.views.trees["BOM Configurator"];t.expanded?(t.$tree_link.trigger("click"),t.$toolbar.find(".expand-all-btn").html(__("Expand All"))):(r.tree.load_children(t,!0),$(t.parent[0]).find(".tree-children").show(),t.$toolbar.find(".expand-all-btn").html(__("Collapse All")))},condition:function(t){return t.expandable&&t.is_root},btnClass:"hidden-xs expand-all-btn"}]}}add_item(e,a){frappe.prompt([{label:__("Item"),fieldname:"item_code",fieldtype:"Link",options:"Item",reqd:1},{label:__("Qty"),fieldname:"qty",default:1,fieldtype:"Float",reqd:1}],i=>{e.data.parent_id||(e.data.parent_id=this.frm.doc.name),frappe.call({method:"erpnext.manufacturing.doctype.bom_creator.bom_creator.add_item",args:{parent:e.data.parent_id,fg_item:e.data.value,item_code:i.item_code,fg_reference_id:e.data.name||this.frm.doc.name,qty:i.qty},callback:t=>{a.events.load_tree(t,e)}})},__("Add Item"),__("Add"))}set_query_for_workstation(e){let a=e.fields.filter(i=>i.fieldname==="workstation");a.length&&(a[0].get_query=function(){if(e.get_value("workstation_type"))return{filters:{workstation_type:e.get_value("workstation_type")}}})}add_sub_assembly(e,a){let i=new frappe.ui.Dialog({fields:a.events.get_sub_assembly_modal_fields(a,e.is_root),title:__("Add Sub Assembly")});a.events.set_query_for_workstation(i),i.show(),i.set_primary_action(__("Add"),()=>{var r;let t=i.get_values();i.operation&&!i.workstation_type&&!i.workstation&&frappe.throw(__("Either Workstation or Workstation Type is mandatory")),(r=e.data)!=null&&r.parent_id||(e.data.parent_id=this.frm.doc.name),frappe.call({method:"erpnext.manufacturing.doctype.bom_creator.bom_creator.add_sub_assembly",args:{parent:e.data.parent_id,fg_item:e.data.value,fg_reference_id:e.data.name||this.frm.doc.name,bom_item:t,operation:e.data.operation,workstation_type:e.data.workstation_type,operation_time:e.data.operation_time},callback:o=>{a.events.load_tree(o,e)}}),i.hide()})}get_sub_assembly_modal_fields(e,a=!1,i=!1){let t=[{label:__("Sub Assembly Item"),fieldname:"item_code",fieldtype:"Link",options:"Item",reqd:1,read_only:i},{fieldtype:"Column Break"},{label:__("Qty"),fieldname:"qty",default:1,fieldtype:"Float",reqd:1,read_only:i,change(){this.layout.fields_dict.items.grid.data.forEach(r=>{r.qty=flt(this.value)}),this.layout.fields_dict.items.grid.refresh()}}];return a&&t.push({fieldtype:"Section Break"},{label:__("Operation"),fieldname:"operation",fieldtype:"Link",options:"Operation",get_query(){let r=e.events.frm.doc;if(r.routing)return{query:"erpnext.manufacturing.doctype.routing.routing.get_operations",filters:{routing:r.routing}}}}),t.push({fieldtype:"Section Break"},{label:__("Raw Materials"),fieldname:"items",fieldtype:"Table",reqd:1,fields:[{label:__("Item"),fieldname:"item_code",fieldtype:"Link",options:"Item",reqd:1,in_list_view:1,change(){let r=this.doc;r.qty=1,this.grid.set_value("qty",1,r)}},{label:__("Qty"),fieldname:"qty",default:1,fieldtype:"Float",reqd:1,in_list_view:1}]}),t}convert_to_sub_assembly(e,a){let i=new frappe.ui.Dialog({fields:a.events.get_sub_assembly_modal_fields(a,e.is_root,!0),title:__("Add Sub Assembly")});i.set_values({item_code:e.data.value,qty:e.data.qty}),i.show(),i.set_primary_action(__("Add"),()=>{let t=i.get_values();t.item_code||frappe.throw(__("Sub Assembly Item is mandatory")),t.items.forEach(r=>{r.item_code||frappe.throw(__("Item is mandatory in Raw Materials table."))}),i.operation&&!i.workstation_type&&!i.workstation&&frappe.throw(__("Either Workstation or Workstation Type is mandatory")),frappe.call({method:"erpnext.manufacturing.doctype.bom_creator.bom_creator.add_sub_assembly",args:{parent:e.data.parent_id,fg_item:e.data.value,bom_item:t,fg_reference_id:e.data.name||this.frm.doc.name,convert_to_sub_assembly:!0,operation:e.data.operation,workstation_type:e.data.workstation_type,operation_time:e.data.operation_time,workstation:e.data.workstation},callback:r=>{e.expandable=!0,a.events.load_tree(r,e.parent_node)}}),i.hide()})}set_default_qty(e){e.fields_dict.items.grid.fields_map.item_code.onchange=function(a){if(a){let i=$(a.currentTarget).closest(".grid-row").attr("data-name"),t=e.fields_dict.items.grid.grid_rows_by_docname[i].doc;t.qty=1,e.fields_dict.items.grid.refresh()}}}delete_node(e,a){frappe.confirm(__("Are you sure you want to delete this Item?"),()=>{frappe.call({method:"erpnext.manufacturing.doctype.bom_creator.bom_creator.delete_node",args:{parent:e.data.parent_id,fg_item:e.data.value,doctype:e.data.doctype,docname:e.data.name},callback:i=>{a.events.load_tree(i,e.parent_node)}})})}edit_bom(e,a){let i=this,t=e.data.qty||this.frm.doc.qty,r=[{label:__("Qty"),fieldname:"qty",default:t,fieldtype:"Float",reqd:1}];this.frm.edit_bom_dialog=frappe.prompt(r,o=>{let d=e.data.doctype||this.frm.doc.doctype,s=e.data.name||this.frm.doc.name;frappe.call({method:"erpnext.manufacturing.doctype.bom_creator.bom_creator.edit_bom_creator",args:{doctype:d,docname:s,data:o,parent:e.data.parent_id||this.frm.doc.name},callback:c=>{for(let m in o)e.data[m]=o[m];let u=e.data.uom||this.frm.doc.uom;$(e.parent.get(0)).find(`[data-bom-qty-docname='${s}']`).html(o.qty+" "+u),a.events.load_tree(c,e)}})},__("Edit BOM"),__("Update"))}prepare_layout(){let e=$(this.page)[0];e.style.marginBottom="15px",$(e).find(".tree-children")[0].style.minHeight="370px",$(e).find(".tree-children")[0].style.maxHeight="370px",$(e).find(".tree-children")[0].style.overflowY="auto"}load_tree(e,a){let i="",t="",r=e.message.raw_material_cost;for(frappe.views.trees["BOM Configurator"].tree.load_children(a);a;)i=e.message.items.filter(o=>o.name===a.data.name),i!=null&&i.length?(a.data.amount=i[0].amount,r=a.data.amount):r=e.message.raw_material_cost,t=$(a.parent.get(0)),r=frappe.format(r,{fieldtype:"Currency",currency:this.frm.doc.currency}),$($(t).find(".fg-item-amt")[0]).html(r),a=a.parent_node}};frappe.ui.BOMConfigurator=_;})();
//# sourceMappingURL=bom_configurator.bundle.HVCV6OL2.js.map
